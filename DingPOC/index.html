<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡˜é‡˜-Apollo å“¡å·¥æ•¸æ“šé›†æˆ POC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4aa3ff;
            --secondary: #00d4aa;
            --accent: #ff6b6b;
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --text: #e8eaed;
            --text-muted: #9aa0a6;
            --border: #2d3748;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #2d3748 100%);
            color: var(--text);
            min-height: 100vh;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card {
            background: rgba(26, 31, 46, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(74, 163, 255, 0.3);
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 163, 255, 0.4);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .status-departed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        .nav-tab {
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .nav-tab:not(.active):hover {
            background: rgba(74, 163, 255, 0.1);
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .table th {
            background: rgba(45, 55, 72, 0.5);
            font-weight: 600;
            color: var(--text);
        }
        
        .table tr:hover {
            background: rgba(74, 163, 255, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(74, 163, 255, 0.1) 0%, rgba(0, 212, 170, 0.1) 100%);
            border: 1px solid rgba(74, 163, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .progress-bar {
            background: rgba(45, 55, 72, 0.5);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: width 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 163, 255, 0.3);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-4">
                    é‡˜é‡˜-Apollo å“¡å·¥æ•¸æ“šé›†æˆå¹³å°
                </h1>
                <p class="text-lg text-gray-300">
                    å¯¦æ™‚å“¡å·¥æ•¸æ“šåŒæ­¥èˆ‡ç®¡ç†ç³»çµ±
                </p>
            </header>

            <!-- Navigation -->
            <nav class="flex flex-wrap justify-center gap-4 mb-8">
                <button class="nav-tab active" data-tab="dashboard">æ•¸æ“šå„€è¡¨æ¿</button>
                <button class="nav-tab" data-tab="employees">å“¡å·¥ç®¡ç†</button>
                <button class="nav-tab" data-tab="sync">æ•¸æ“šåŒæ­¥</button>
                <button class="nav-tab" data-tab="config">API é…ç½®</button>
                <button class="nav-tab" data-tab="docs">API æ–‡æª”</button>
            </nav>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Statistics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="stat-number" id="total-count">0</div>
                        <div class="text-gray-400">ç¸½å“¡å·¥æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-count">0</div>
                        <div class="text-gray-400">åœ¨è·å“¡å·¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-count">0</div>
                        <div class="text-gray-400">å¾…å…¥è·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="departed-count">0</div>
                        <div class="text-gray-400">é›¢è·å“¡å·¥</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">å“¡å·¥ç‹€æ…‹åˆ†ä½ˆ</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">æœˆåº¦å…¥è·è¶¨å‹¢</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3 class="text-xl font-bold mb-4">æœ€è¿‘åŒæ­¥æ´»å‹•</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-green-900 bg-opacity-30 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span>æ•¸æ“šåŒæ­¥å®Œæˆ</span>
                            </div>
                            <span class="text-sm text-gray-400">å‰›æ‰</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-blue-900 bg-opacity-30 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span>ç²å–åœ¨è·å“¡å·¥åˆ—è¡¨</span>
                            </div>
                            <span class="text-sm text-gray-400">2åˆ†é˜å‰</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-yellow-900 bg-opacity-30 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <span>æ›´æ–° API æ†‘è­‰</span>
                            </div>
                            <span class="text-sm text-gray-400">5åˆ†é˜å‰</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employees Tab -->
            <div id="employees" class="tab-content">
                <div class="card">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h3 class="text-2xl font-bold gradient-text mb-4 sm:mb-0">å“¡å·¥æ•¸æ“šåˆ—è¡¨</h3>
                        <div class="flex space-x-3">
                            <select id="statusFilter" class="form-input w-auto">
                                <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="åœ¨èŒ">åœ¨è·</option>
                                <option value="å¾…å…¥èŒ">å¾…å…¥è·</option>
                                <option value="ç¦»èŒ">é›¢è·</option>
                            </select>
                            <button class="btn btn-success" onclick="refreshEmployees()">
                                ğŸ”„ åˆ·æ–°æ•¸æ“š
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å§“å</th>
                                    <th>å“¡å·¥ID</th>
                                    <th>éƒ¨é–€</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>å“¡å·¥éƒµç®±</th>
                                    <th>å…¥è·æ—¥æœŸ</th>
                                    
                                </tr>
                            </thead>
                            <tbody id="employeeTable">
                                <!-- Employee data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sync Tab -->
            <div id="sync" class="tab-content">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">æ•¸æ“šåŒæ­¥æ§åˆ¶</h3>
                        <div class="space-y-4">
                            <button class="btn w-full" onclick="startSync()">
                                <span id="syncButtonText">ğŸš€ é–‹å§‹æ•¸æ“šåŒæ­¥</span>
                            </button>
                            <button class="btn btn-danger w-full" onclick="clearData()">
                                ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š
                            </button>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-bold mb-3">åŒæ­¥é€²åº¦</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span id="syncStatus">ç­‰å¾…é–‹å§‹</span>
                                    <span id="syncProgress">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">åŒæ­¥çµ±è¨ˆ</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span>åœ¨è·å“¡å·¥</span>
                                <span class="font-bold text-green-400" id="syncActiveCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å¾…å…¥è·å“¡å·¥</span>
                                <span class="font-bold text-yellow-400" id="syncPendingCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>é›¢è·å“¡å·¥</span>
                                <span class="font-bold text-red-400" id="syncDepartedCount">0</span>
                            </div>
                            <hr class="border-gray-600">
                            <div class="flex justify-between text-lg font-bold">
                                <span>ç¸½è¨ˆ</span>
                                <span class="gradient-text" id="syncTotalCount">0</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                æœ€å¾ŒåŒæ­¥ï¼š
                                <span id="lastSyncTime">â€”</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sync Log -->
                <div class="card mt-8">
                    <h3 class="text-xl font-bold mb-4">åŒæ­¥æ—¥èªŒ</h3>
                    <div class="bg-black bg-opacity-50 rounded-lg p-4 font-mono text-sm max-h-64 overflow-y-auto" id="syncLog">
                        <div class="text-green-400">[2025-09-08 14:30:26] ğŸš€ å¼€å§‹å‘˜å·¥æ•°æ®åŒæ­¥...</div>
                        <div class="text-blue-400">[2025-09-08 14:30:27] ğŸ”‘ æ›´æ–°é’‰é’‰APIå‡­è¯...</div>
                        <div class="text-green-400">[2025-09-08 14:30:28] âœ… APIå‡­è¯å·²æ›´æ–°</div>
                        <div class="text-blue-400">[2025-09-08 14:30:29] ğŸ‘¥ è·å–åœ¨èŒå‘˜å·¥åˆ—è¡¨...</div>
                        <div class="text-blue-400">[2025-09-08 14:30:30] â³ è·å–å¾…å…¥èŒå‘˜å·¥åˆ—è¡¨...</div>
                        <div class="text-blue-400">[2025-09-08 14:30:31] ğŸšª è·å–ç¦»èŒå‘˜å·¥åˆ—è¡¨...</div>
                        <div class="text-green-400">[2025-09-08 14:30:33] âœ… è·å–åˆ° 3 ååœ¨èŒå‘˜å·¥</div>
                        <div class="text-green-400">[2025-09-08 14:30:34] âœ… è·å–åˆ° 4 åå¾…å…¥èŒå‘˜å·¥</div>
                        <div class="text-green-400">[2025-09-08 14:30:35] âœ… è·å–åˆ° 2 åç¦»èŒå‘˜å·¥</div>
                        <div class="text-green-400">[2025-09-08 14:30:36] âœ… æˆåŠŸä¿å­˜ 9 æ¡å‘˜å·¥è®°å½•</div>
                        <div class="text-green-400">[2025-09-08 14:30:37] âœ… æ•°æ®åŒæ­¥å®Œæˆ</div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="config" class="tab-content">
                <div class="card max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold gradient-text mb-6">é‡˜é‡˜ API é…ç½®</h3>
                    
                    <form id="configForm" class="space-y-6">
                        <div class="form-group">
                            <label class="form-label">ä¼æ¥­ ID (Corp ID)</label>
                            <input type="text" id="corpId" class="form-input" placeholder="è«‹è¼¸å…¥ä¼æ¥­ ID" />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Client ID</label>
                            <input type="text" id="clientId" class="form-input" placeholder="è«‹è¼¸å…¥ Client ID" />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Client Secret</label>
                            <input type="password" id="clientSecret" class="form-input" placeholder="è«‹è¼¸å…¥ Client Secret" />
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="button" class="btn btn-success flex-1" onclick="saveConfig()">
                                ğŸ’¾ ä¿å­˜é…ç½®
                            </button>
                            <button type="button" class="btn flex-1" onclick="testConfig()">
                                ğŸ§ª æ¸¬è©¦é€£æ¥
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-8 p-4 bg-blue-900 bg-opacity-30 rounded-lg">
                        <h4 class="font-bold mb-2">ğŸ”— ç²å– API æ†‘è­‰æ­¥é©Ÿï¼š</h4>
                        <ol class="list-decimal list-inside space-y-1 text-sm">
                            <li>è¨ªå• <a href="https://open.dingtalk.com/" target="_blank" class="text-blue-400 hover:underline">é‡˜é‡˜é–‹æ”¾å¹³å°</a></li>
                            <li>å‰µå»ºä¼æ¥­å…§éƒ¨æ‡‰ç”¨</li>
                            <li>ç²å– AppKey å’Œ AppSecret</li>
                            <li>é…ç½®æ‡‰ç”¨æ¬Šé™ï¼ˆæ™ºèƒ½äººäº‹ç›¸é—œï¼‰</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Docs Tab (API Usage) -->
            <div id="docs" class="tab-content">
                <div class="card">
                    <h3 class="text-2xl font-bold gradient-text mb-4">API ä½¿ç”¨æµç¨‹åœ–</h3>
                    <div class="w-full overflow-x-auto">
                        <svg viewBox="0 0 1280 560" width="100%" height="460" role="img" aria-label="API ä½¿ç”¨æµç¨‹åœ–">
                            <defs>
                                <linearGradient id="gPrimary" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#4aa3ff"/>
                                    <stop offset="100%" stop-color="#00d4aa"/>
                                </linearGradient>
                                <linearGradient id="gFallback" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#ff6b6b"/>
                                    <stop offset="100%" stop-color="#ff9e9e"/>
                                </linearGradient>
                                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.35"/>
                                </filter>
                                <marker id="arrowHead" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                                    <path d="M0,0 L10,4 L0,8 Z" fill="#4aa3ff"></path>
                                </marker>
                                <style>
                                    .lane { fill:#151b28; stroke:#2d3748; }
                                    .node { fill:#0f1625; stroke:url(#gPrimary); stroke-width:1.6; filter:url(#shadow); }
                                    .node--fallback { stroke:url(#gFallback); }
                                    .label { font:600 14px 'Noto Sans TC', system-ui, -apple-system; fill:#e8eaed; }
                                    .sublabel { font:12px 'Noto Sans TC', system-ui, -apple-system; fill:#9aa0a6; }
                                    .badge { fill:url(#gPrimary); }
                                    .badge text { font:700 12px 'Noto Sans TC'; fill:#00111a; }
                                    .legend text { font:12px 'Noto Sans TC'; fill:#9aa0a6; }
                                </style>
                            </defs>

                            <!-- lanes -->
                            <rect class="lane" x="20" y="20" width="1240" height="90" rx="10"></rect>
                            <text x="28" y="50" class="label" style="fill:#9aa0a6;font-weight:700;">èªè­‰</text>

                            <rect class="lane" x="20" y="120" width="1240" height="110" rx="10"></rect>
                            <text x="28" y="150" class="label" style="fill:#9aa0a6;font-weight:700;">äººå“¡ ID æ‹‰å–</text>

                            <rect class="lane" x="20" y="240" width="1240" height="110" rx="10"></rect>
                            <text x="28" y="270" class="label" style="fill:#9aa0a6;font-weight:700;">èŠ±åå†Šå­—æ®µï¼ˆæ‰¹é‡ï¼‰èˆ‡å›é€€è£œé½Š</text>

                            <rect class="lane" x="20" y="360" width="1240" height="160" rx="10"></rect>
                            <text x="28" y="390" class="label" style="fill:#9aa0a6;font-weight:700;">ETL èˆ‡æŒä¹…åŒ–/å‰ç«¯ä½¿ç”¨</text>

                            <!-- nodes -->
                            <!-- auth -->
                            <rect class="node" x="120" y="44" width="350" height="50" rx="10"></rect>
                            <circle class="badge" cx="130" cy="52" r="12"/>
                            <text x="130" y="56" text-anchor="middle">1</text>
                            <text x="295" y="72" text-anchor="middle" class="label">POST /v1.0/oauth2/{corpId}/token</text>
                            <text x="295" y="92" text-anchor="middle" class="sublabel">å–å¾— access_tokenï¼ˆå¾Œç«¯å¿«å–ï¼‰</text>

                            <!-- id queries -->
                            <rect class="node" x="80" y="164" width="320" height="56" rx="10"></rect>
                            <circle class="badge" cx="90" cy="172" r="11"/>
                            <text x="90" y="176" text-anchor="middle">2</text>
                            <text x="240" y="190" text-anchor="middle" class="label">åœ¨è·ï¼šqueryonjob</text>

                            <rect class="node" x="480" y="164" width="320" height="56" rx="10"></rect>
                            <circle class="badge" cx="490" cy="172" r="11"/>
                            <text x="490" y="176" text-anchor="middle">3</text>
                            <text x="640" y="190" text-anchor="middle" class="label">å¾…å…¥è·ï¼šquerypreentry</text>

                            <rect class="node" x="880" y="164" width="320" height="56" rx="10"></rect>
                            <circle class="badge" cx="890" cy="172" r="11"/>
                            <text x="890" y="176" text-anchor="middle">4</text>
                            <text x="1040" y="190" text-anchor="middle" class="label">é›¢è·ï¼šdismissions</text>

                            <!-- roster v2 -->
                            <rect class="node" x="140" y="264" width="460" height="56" rx="10"></rect>
                            <circle class="badge" cx="150" cy="272" r="11"/>
                            <text x="150" y="276" text-anchor="middle">5</text>
                            <text x="370" y="290" text-anchor="middle" class="label">POST /topapi/.../employee/v2/list</text>
                            <text x="370" y="310" text-anchor="middle" class="sublabel">userid_list + field_filter_listï¼ˆâ‰¤100ï¼‰</text>

                            <!-- fallbacks -->
                            <rect class="node node--fallback" x="650" y="246" width="270" height="40" rx="8"></rect>
                            <text x="785" y="271" text-anchor="middle" class="sublabel">å›é€€ 1ï¼š/topapi/.../employee/listï¼ˆsys00-*ï¼‰</text>

                            <rect class="node node--fallback" x="650" y="296" width="270" height="40" rx="8"></rect>
                            <text x="785" y="321" text-anchor="middle" class="sublabel">å›é€€ 2ï¼š/topapi/v2/user/getï¼ˆdept_id_listï¼‰</text>

                            <!-- etl & store -->
                            <rect class="node" x="120" y="412" width="300" height="60" rx="10"></rect>
                            <circle class="badge" cx="130" cy="420" r="11"/>
                            <text x="130" y="424" text-anchor="middle">6</text>
                            <text x="270" y="440" text-anchor="middle" class="label">ETL æ¸…æ´—èˆ‡åˆä½µå­—æ®µ</text>

                            <rect class="node" x="460" y="412" width="260" height="60" rx="10"></rect>
                            <text x="590" y="440" text-anchor="middle" class="label">SQLite æŒä¹…åŒ–</text>

                            <rect class="node" x="760" y="412" width="360" height="60" rx="10"></rect>
                            <text x="940" y="438" text-anchor="middle" class="label">å‰ç«¯ AJAX</text>
                            <text x="940" y="458" text-anchor="middle" class="sublabel">GET /api/employees ãƒ» POST /api/sync-employees</text>

                            <!-- lines -->
                            <g stroke="#4aa3ff" stroke-width="2" fill="none" marker-end="url(#arrowHead)">
                                <!-- auth -> three id queries -->
                                <path d="M295,94 L295,164"></path>
                                <path d="M295,94 C295,130 640,120 640,164"></path>
                                <path d="M295,94 C295,120 1040,120 1040,164"></path>

                                <!-- three -> roster v2 -->
                                <path d="M240,220 L240,264"></path>
                                <path d="M640,220 C640,240 500,240 500,264"></path>
                                <path d="M1040,220 C1040,240 500,240 500,264"></path>

                                <!-- roster -> etl -->
                                <path d="M370,320 C370,360 270,360 270,412"></path>

                                <!-- fallbacks -> etl (dashed) -->
                                <path d="M785,286 C785,300 700,360 420,412" stroke-dasharray="6 5"></path>
                                <path d="M785,336 C785,340 720,380 420,412" stroke-dasharray="6 5"></path>

                                <!-- etl -> db -> frontend -->
                                <path d="M420,442 L460,442"></path>
                                <path d="M720,442 L760,442"></path>
                            </g>

                            <!-- legend -->
                            <g class="legend">
                                <rect x="22" y="528" width="16" height="10" fill="url(#gPrimary)"/>
                                <text x="42" y="536">ä¸»æµç¨‹</text>
                                <rect x="110" y="528" width="16" height="10" fill="url(#gFallback)"/>
                                <text x="130" y="536">å›é€€è£œé½Š</text>
                                <circle cx="210" cy="533" r="6" fill="url(#gPrimary)"/>
                                <text x="222" y="536">æ­¥é©Ÿç·¨è™Ÿ</text>
                            </g>
                        </svg>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-2xl font-bold gradient-text mb-2">API ä½¿ç”¨æ–‡æª”</h3>
                    <p class="text-gray-300 mb-4">åƒè€ƒåŸå‹•æ…‹é é¢å…§å®¹ï¼Œæ•´ç†æœ¬ POC ä½¿ç”¨åˆ°çš„é‡˜é‡˜æ™ºèƒ½äººäº‹ API èˆ‡å¾Œç«¯æ¥å£ï¼ŒåŒ…å«è«‹æ±‚æ–¹å¼ã€åƒæ•¸èˆ‡èª¿ç”¨ç¤ºä¾‹ã€‚</p>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold mb-2">è³‡æ–™æµç¨‹æ¦‚è¦</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-300">
                                <li>å¾Œç«¯ä»¥ <code>corpId + clientId + clientSecret</code> å–å¾— Access Token ä¸¦å¿«å–ã€‚</li>
                                <li>æ‹‰å–ä¸‰é¡äººå“¡ IDï¼šåœ¨è·ã€å¾…å…¥è·ã€é›¢è·ã€‚</li>
                                <li>æ‰¹é‡èŠ±åå†Š API å–å¾—æ ¸å¿ƒå­—æ®µï¼ˆå§“åã€éƒµç®±ã€ä¸»éƒ¨é–€ã€å…¥è·æ—¥æœŸç­‰ï¼‰ã€‚</li>
                                <li>å¿…è¦æ™‚å›é€€èˆŠç‰ˆèŠ±åå†Šèˆ‡ <code>user/get</code> è£œé½Šç¼ºå¤±å­—æ®µã€‚</li>
                                <li>ETL æ¸…æ´—å¾Œå­˜å…¥ SQLiteï¼Œå‰ç«¯é€é AJAX é¡¯ç¤ºã€‚</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-bold mb-2">å¾Œç«¯æ¥å£ï¼ˆæœ¬ POCï¼‰</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-300">
                                <li><code>GET /health</code> å¥åº·æª¢æŸ¥</li>
                                <li><code>GET /api/employees</code> å–å¾—å“¡å·¥æ¸…å–®</li>
                                <li><code>POST /api/sync-employees</code> è§¸ç™¼åŒæ­¥ï¼ˆéœ€ <code>corpId/clientId/clientSecret</code>ï¼‰</li>
                                <li><code>DELETE /api/employees</code> æ¸…ç©ºæœ¬åœ°è³‡æ–™ï¼ˆæ¸¬è©¦ç”¨ï¼‰</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8 mt-8">
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">ğŸ”‘ èªè­‰ï¼ˆAccess Tokenï¼‰</h3>
                        <div class="text-sm text-gray-300 space-y-2">
                            <div><b>æ–¹æ³•ï¼š</b>POST</div>
                            <div><b>URLï¼š</b><code>https://api.dingtalk.com/v1.0/oauth2/{corpId}/token</code></div>
                            <div><b>Bodyï¼š</b><code>client_id</code>ã€<code>client_secret</code>ã€<code>grant_type=client_credentials</code></div>
                            <div><b>å›æ‡‰ï¼š</b><code>access_token</code>ã€<code>expires_in</code>ï¼ˆéæœŸå‰ 5 åˆ†é˜è‡ªå‹•åˆ·æ–°ï¼‰</div>
                        </div>
                        <h4 class="font-bold mt-4 mb-2">cURL</h4>
                        <pre class="bg-black bg-opacity-50 rounded-lg p-3 text-xs overflow-auto">curl -X POST \
  'https://api.dingtalk.com/v1.0/oauth2/{corpId}/token' \
  -H 'Content-Type: application/json' \
  -d '{
  "client_id": "&lt;CLIENT_ID&gt;",
  "client_secret": "&lt;CLIENT_SECRET&gt;",
  "grant_type": "client_credentials"
}'</pre>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">ğŸ‘¥ äººå“¡ ID æ‹‰å–</h3>
                        <div class="text-sm text-gray-300 space-y-2">
                            <div><b>åœ¨è·ï¼š</b>POST <code>/topapi/smartwork/hrm/employee/queryonjob</code></div>
                            <div><b>å¾…å…¥è·ï¼š</b>POST <code>/topapi/smartwork/hrm/employee/querypreentry</code></div>
                            <div><b>é›¢è·ï¼š</b>GET <code>/v1.0/hrm/employees/dismissions</code></div>
                            <div class="text-gray-400">çš†æ”¯æ´åˆ†é ï¼›å…ˆæ”¶é›†æ‰€æœ‰ <code>userid</code>ï¼Œå†æ‰¹é‡æŸ¥èŠ±åå†Šå­—æ®µã€‚</div>
                        </div>
                        <h4 class="font-bold mt-4 mb-2">cURL</h4>
                        <pre class="bg-black bg-opacity-50 rounded-lg p-3 text-xs overflow-auto"># å¾…å…¥è·
curl -X POST \
  'https://oapi.dingtalk.com/topapi/smartwork/hrm/employee/querypreentry?access_token=&lt;ACCESS_TOKEN&gt;' \
  -H 'Content-Type: application/json' \
  -d '{"offset":0,"size":50}'

# é›¢è·
curl -G \
  'https://api.dingtalk.com/v1.0/hrm/employees/dismissions' \
  --data-urlencode 'nextToken=0' \
  --data-urlencode 'maxResults=50' \
  -H 'x-acs-dingtalk-access-token: &lt;ACCESS_TOKEN&gt;'</pre>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">ğŸ“’ èŠ±åå†Šå­—æ®µï¼ˆæ‰¹é‡ï¼‰</h3>
                        <div class="text-sm text-gray-300 space-y-2">
                            <div><b>æ–¹æ³•ï¼š</b>POST</div>
                            <div><b>URLï¼š</b><code>/topapi/smartwork/hrm/employee/v2/list</code></div>
                            <div><b>Bodyï¼š</b><code>userid_list</code>ï¼ˆâ‰¤100ï¼‰ã€<code>field_filter_list</code>ï¼ˆå¯é¸ï¼Œâ‰¤100ï¼›æœªå‚³ç‚ºå…¨éƒ¨ï¼‰ã€<code>agentid</code></div>
                            <div><b>é‡é»å­—æ®µï¼š</b>å§“åã€éƒµç®±ã€ä¸»éƒ¨é–€ID/åç¨±ã€è·ä½/è·ç´šã€<b>å…¥è·æ—¥æœŸ</b></div>
                            <div class="text-gray-400">å…¥è·æ—¥æœŸå¯ä¾†è‡ª <code>sys01-hiredDate</code>ã€<code>sys01-entryTime</code> æˆ–å­—æ®µåã€Œå…¥è·æ—¥æœŸ/å…¥è·æ™‚é–“ã€ï¼›å‰ç«¯é¡¯ç¤ºç‚º YYYY-MM-DDã€‚</div>
                        </div>
                        <h4 class="font-bold mt-4 mb-2">cURL</h4>
                        <pre class="bg-black bg-opacity-50 rounded-lg p-3 text-xs overflow-auto">curl -X POST \
  'https://oapi.dingtalk.com/topapi/smartwork/hrm/employee/v2/list?access_token=&lt;ACCESS_TOKEN&gt;' \
  -H 'Content-Type: application/json' \
  -d '{
  "userid_list": "10001,10002,10003",
  "field_filter_list": "sys01-name,sys01-email,sys01-mainDept,sys01-mainDeptName,sys01-hiredDate",
  "agentid": 1
}'</pre>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-bold mb-4">ğŸ§© ç¼ºå¤±å­—æ®µè£œé½Š</h3>
                        <div class="text-sm text-gray-300 space-y-2">
                            <div>è‹¥ v2 èŠ±åå†Šç¼ºå°‘é—œéµå­—æ®µï¼ˆå¦‚ä¸»éƒ¨é–€/å…¥è·æ—¥æœŸï¼‰ï¼Œæœƒå›é€€ï¼š</div>
                            <ul class="list-disc list-inside space-y-1 ml-2">
                                <li>èˆŠç‰ˆèŠ±åå†Šï¼šPOST <code>/topapi/smartwork/hrm/employee/list</code>ï¼ˆå– <code>sys00-*</code>ï¼‰</li>
                                <li>ç”¨æˆ¶è©³æƒ…ï¼šPOST <code>/topapi/v2/user/get</code>ï¼ˆè£œ <code>dept_id_list[0]</code>ï¼‰</li>
                            </ul>
                            <div class="text-gray-400">ä¸¦ç™¼ + åˆ†ç‰‡èˆ‡æŒ‡æ•¸å›é€€é‡è©¦ï¼Œæœ€çµ‚åˆä½µå­—æ®µåˆ°å–®ä¸€ç”¨æˆ¶ã€‚</div>
                        </div>
                    </div>
                </div>

                <div class="card mt-8">
                    <h3 class="text-xl font-bold mb-2">ğŸ“š å€‰åº«å…§åŸå§‹æ–‡æª”</h3>
                    <ul class="list-disc list-inside text-sm text-blue-300">
                        <li><a class="hover:underline" href="./APIæ–‡æª”/è·å–åœ¨èŒå‘˜å·¥åˆ—è¡¨.md" target="_blank">è·å–åœ¨èŒå‘˜å·¥åˆ—è¡¨.md</a></li>
                        <li><a class="hover:underline" href="./APIæ–‡æª”/è·å–å¾…å…¥èŒå‘˜å·¥åˆ—è¡¨.md" target="_blank">è·å–å¾…å…¥èŒå‘˜å·¥åˆ—è¡¨.md</a></li>
                        <li><a class="hover:underline" href="./APIæ–‡æª”/è·å–ç¦»èŒå‘˜å·¥åˆ—è¡¨.md" target="_blank">è·å–ç¦»èŒå‘˜å·¥åˆ—è¡¨.md</a></li>
                        <li><a class="hover:underline" href="./APIæ–‡æª”/è·å–å‘˜å·¥èŠ±åå†Œå­—æ®µä¿¡æ¯.md" target="_blank">è·å–å‘˜å·¥èŠ±åå†Œå­—æ®µä¿¡æ¯.md</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- App Script: AJAX to backend API -->
    <script>
        // Backend API configuration
        const API_BASE_URL = 'http://localhost:8000';
        
        // Employee data will be loaded from API
        let employeeData = [];
        let filteredEmployees = [];

        // Chart instances (to avoid duplicate init errors)
        let charts = { status: null, trend: null };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            loadEmployeeData();
            initStatusFilter();
        });

        // Tab functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // Date parsing helpers
        function parseDateLoose(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (typeof value === 'number') {
                const d = new Date(value);
                return isNaN(d.getTime()) ? null : d;
            }
            if (typeof value === 'string') {
                let s = value.trim();
                if (!s) return null;
                // Normalize common formats: 'YYYY-MM-DD HH:mm:ss' -> 'YYYY-MM-DDTHH:mm:ss'
                if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(s)) {
                    s = s.replace(' ', 'T');
                }
                // Replace '/' with '-' to help Date parse
                if (s.includes('/')) s = s.replace(/\//g, '-');
                const d = new Date(s);
                return isNaN(d.getTime()) ? null : d;
            }
            return null;
        }

        function buildMonthlyTrend(employees, months = 6) {
            const now = new Date();
            const labels = [];
            const data = [];
            for (let i = months - 1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(`${d.getMonth() + 1}æœˆ`);
                data.push(0);
            }
            employees.forEach(emp => {
                const dt = parseDateLoose(emp.joinDate);
                if (!dt) return;
                const diffMonths = (now.getFullYear() - dt.getFullYear()) * 12 + (now.getMonth() - dt.getMonth());
                if (diffMonths >= 0 && diffMonths < months) {
                    data[months - 1 - diffMonths] += 1;
                }
            });
            return { labels, data };
        }

        // Initialize charts
        function initCharts() {
            const activeCount = employeeData.filter(emp => emp.status === 'åœ¨èŒ').length;
            const pendingCount = employeeData.filter(emp => emp.status === 'å¾…å…¥èŒ').length;
            const departedCount = employeeData.filter(emp => emp.status === 'ç¦»èŒ').length;
            
            // Status distribution chart
            const statusCanvas = document.getElementById('statusChart');
            if (!statusCanvas) return;
            const statusCtx = statusCanvas.getContext('2d');
            if (charts.status) { try { charts.status.destroy(); } catch (_) {} }
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['åœ¨è·', 'å¾…å…¥è·', 'é›¢è·'],
                    datasets: [{
                        data: [activeCount, pendingCount, departedCount],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e8eaed' }
                        }
                    }
                }
            });

            // Trend chart from actual join dates in last 6 months
            const trendCanvas = document.getElementById('trendChart');
            if (!trendCanvas) return;
            const trendCtx = trendCanvas.getContext('2d');
            if (charts.trend) { try { charts.trend.destroy(); } catch (_) {} }
            const trendSeries = buildMonthlyTrend(employeeData, 6);
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendSeries.labels,
                    datasets: [{
                        label: 'å…¥è·äººæ•¸',
                        data: trendSeries.data,
                        borderColor: '#4aa3ff',
                        backgroundColor: 'rgba(74, 163, 255, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e8eaed' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#9aa0a6' },
                            grid: { color: '#2d3748' }
                        },
                        y: { 
                            ticks: { color: '#9aa0a6' },
                            grid: { color: '#2d3748' }
                        }
                    }
                }
            });
        }

        function formatDateDisplay(val) {
            const d = parseDateLoose(val);
            if (!d) return val || 'N/A';
            // YYYY-MM-DD
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Normalize backend employee to UI shape
        function normalizeEmployee(emp) {
            return {
                userid: emp.userid || emp.id || '',
                name: emp.name || '',
                department: emp.departmentName || emp.department || '',
                email: emp.email || '',
                status: emp.status || '',
                joinDate: emp.hiredDate || emp.hired_date || emp.joinDate || '',
                updateTime: emp.updatedAt || emp.updateTime || emp.updated_at || ''
            };
        }

        // Load employee data from backend API
        async function loadEmployeeData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/employees`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    employeeData = Array.isArray(result.data) ? result.data.map(normalizeEmployee) : [];
                    filteredEmployees = [...employeeData];
                    updateDashboardStats();
                    initCharts();
                    renderEmployeeTable();
                    
                    // Update last sync time if available
                    const lastSync = result.timestamp || new Date().toISOString();
                    document.getElementById('lastSyncTime').textContent = formatTimestamp(lastSync);
                } else {
                    console.warn('Failed to load employee data:', result);
                    // Fallback to empty state
                    employeeData = [];
                    filteredEmployees = [];
                    renderEmployeeTable();
                }
            } catch (error) {
                console.error('Error loading employee data:', error);
                // Show error message
                const tbody = document.getElementById('employeeTable');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-400">ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™å™¨ï¼Œè«‹ç¢ºèªæœå‹™å™¨å·²å•Ÿå‹•</td></tr>';
            }
        }
        
        // Update dashboard statistics
        function updateDashboardStats() {
            const activeCount = employeeData.filter(emp => emp.status === 'åœ¨èŒ').length;
            const pendingCount = employeeData.filter(emp => emp.status === 'å¾…å…¥èŒ').length;
            const departedCount = employeeData.filter(emp => emp.status === 'ç¦»èŒ').length;
            
            document.getElementById('total-count').textContent = employeeData.length;
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('departed-count').textContent = departedCount;
            
            document.getElementById('syncActiveCount').textContent = activeCount;
            document.getElementById('syncPendingCount').textContent = pendingCount;
            document.getElementById('syncDepartedCount').textContent = departedCount;
            document.getElementById('syncTotalCount').textContent = employeeData.length;
        }
        
        // Format timestamp for display
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW');
        }
        
        // Render employee table
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTable');
            tbody.innerHTML = '';
            
            if (filteredEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400">æš«ç„¡æ•¸æ“š</td></tr>';
                return;
            }
            
            filteredEmployees.forEach(employee => {
                const row = document.createElement('tr');
                const statusClass = employee.status === 'åœ¨èŒ' ? 'status-active' : 
                                   employee.status === 'å¾…å…¥èŒ' ? 'status-pending' : 'status-departed';
                
                row.innerHTML = `
                    <td>${employee.name || 'N/A'}</td>
                    <td><code>${employee.userid || 'N/A'}</code></td>
                    <td>${employee.department || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${employee.status || 'N/A'}</span></td>
                    <td>${employee.email ? `<a href="mailto:${employee.email}" class="text-blue-400 hover:underline">${employee.email}</a>` : 'N/A'}</td>
                    <td>${formatDateDisplay(employee.joinDate)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Status filter
        function initStatusFilter() {
            const filter = document.getElementById('statusFilter');
            filter.addEventListener('change', function() {
                const status = this.value;
                if (status) {
                    filteredEmployees = employeeData.filter(emp => emp.status === status);
                } else {
                    filteredEmployees = [...employeeData];
                }
                renderEmployeeTable();
            });
        }

        // Real sync function that calls backend API
        async function startSync() {
            const button = document.getElementById('syncButtonText');
            const status = document.getElementById('syncStatus');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('syncProgress');
            
            button.innerHTML = '<span class="loading-spinner"></span> åŒæ­¥ä¸­...';
            status.textContent = 'æº–å‚™åŒæ­¥...';
            
            // Get saved API configuration
            const savedConfig = localStorage.getItem('dingtalk-config');
            if (!savedConfig) {
                alert('è«‹å…ˆé…ç½®é‡˜é‡˜ API ä¿¡æ¯ï¼');
                button.innerHTML = 'ğŸš€ é–‹å§‹æ•¸æ“šåŒæ­¥';
                status.textContent = 'ç­‰å¾…é–‹å§‹';
                return;
            }
            
            try {
                const config = JSON.parse(savedConfig);
                
                // Simulate progress updates
                let progress = 0;
                const updateProgress = (newProgress, statusText) => {
                    progress = newProgress;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                    status.textContent = statusText;
                };
                
                updateProgress(20, 'ç™¼é€åŒæ­¥è«‹æ±‚...');
                
                // Call backend sync API
                const response = await fetch(`${API_BASE_URL}/api/sync-employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        corpId: config.corpId,
                        clientId: config.clientId,
                        clientSecret: config.clientSecret
                    })
                });
                
                updateProgress(70, 'è™•ç†å›æ‡‰æ•¸æ“š...');
                
                const result = await response.json();
                
                updateProgress(90, 'æ›´æ–°æœ¬åœ°æ•¸æ“š...');
                
                if (result.success) {
                    updateProgress(100, 'åŒæ­¥å®Œæˆ');
                    
                    // Reload employee data
                    await loadEmployeeData();
                    
                    // Add success log entry
                    const log = document.getElementById('syncLog');
                    const now = new Date().toLocaleString('zh-TW');
                    log.innerHTML += `<div class="text-green-400">[${now}] âœ… åŒæ­¥æˆåŠŸï¼Œå…±è™•ç† ${result.data.totalProcessed} æ¢è¨˜éŒ„</div>`;
                    log.scrollTop = log.scrollHeight;
                    
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±æ•—');
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                
                // Show error
                status.textContent = 'åŒæ­¥å¤±æ•—';
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                
                // Add error log entry
                const log = document.getElementById('syncLog');
                const now = new Date().toLocaleString('zh-TW');
                log.innerHTML += `<div class="text-red-400">[${now}] âŒ åŒæ­¥å¤±æ•—ï¼š${error.message}</div>`;
                log.scrollTop = log.scrollHeight;
                
                alert('åŒæ­¥å¤±æ•—ï¼š' + error.message);
            } finally {
                button.innerHTML = 'ğŸš€ é–‹å§‹æ•¸æ“šåŒæ­¥';
            }
        }

        async function clearData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å“¡å·¥æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                try {
                    // Call backend clear API
                    const response = await fetch(`${API_BASE_URL}/api/employees`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Reload data to reflect changes
                        await loadEmployeeData();
                        
                        const log = document.getElementById('syncLog');
                        const now = new Date().toLocaleString('zh-TW');
                        log.innerHTML += `<div class="text-red-400">[${now}] ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å“¡å·¥æ•¸æ“š</div>`;
                        log.scrollTop = log.scrollHeight;
                    } else {
                        throw new Error(result.message || 'æ¸…ç©ºå¤±æ•—');
                    }
                    
                } catch (error) {
                    console.error('Clear error:', error);
                    alert('æ¸…ç©ºæ•¸æ“šå¤±æ•—ï¼š' + error.message);
                }
            }
        }

        async function refreshEmployees() {
            // Reload data from backend
            await loadEmployeeData();
            
            const log = document.getElementById('syncLog');
            const now = new Date().toLocaleString('zh-TW');
            log.innerHTML += `<div class="text-blue-400">[${now}] ğŸ”„ åˆ·æ–°å“¡å·¥æ•¸æ“šåˆ—è¡¨</div>`;
            log.scrollTop = log.scrollHeight;
        }

        function saveConfig() {
            const corpId = document.getElementById('corpId').value;
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;
            
            if (!corpId || !clientId || !clientSecret) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„ API é…ç½®ä¿¡æ¯ï¼');
                return;
            }
            
            // Save to localStorage (in real app, would save to backend)
            localStorage.setItem('dingtalk-config', JSON.stringify({
                corpId, clientId, clientSecret
            }));
            
            alert('API é…ç½®å·²ä¿å­˜ï¼');
        }

        async function testConfig() {
            const corpId = document.getElementById('corpId').value;
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;
            
            if (!corpId || !clientId || !clientSecret) {
                alert('è«‹å…ˆå¡«å¯«å®Œæ•´çš„ API é…ç½®ä¿¡æ¯ï¼');
                return;
            }
            
            try {
                // Test backend health first
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                const healthResult = await healthResponse.json();
                
                if (healthResult.status === 'ok') {
                    alert('API é€£æ¥æ¸¬è©¦æˆåŠŸï¼âœ…\nå¾Œç«¯æœå‹™å™¨æ­£å¸¸é‹è¡Œ');
                } else {
                    throw new Error('å¾Œç«¯æœå‹™å™¨å›æ‡‰ç•°å¸¸');
                }
            } catch (error) {
                console.error('Config test error:', error);
                alert('API é€£æ¥æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
            }
        }

        // Load saved config on page load
        window.addEventListener('load', function() {
            const savedConfig = localStorage.getItem('dingtalk-config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('corpId').value = config.corpId || '';
                document.getElementById('clientId').value = config.clientId || '';
                document.getElementById('clientSecret').value = config.clientSecret || '';
            }
        });
    </script>
</body>
</html>
